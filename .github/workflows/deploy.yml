name: Deploy Blazor WASM to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true


jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Setup .NET ─────────────────────────────────────────────────────────
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'

      # ── 3. Publish ───────────────────────────────────────────────────────────
      - name: Publish
        run: |
          BUILD_VERSION=$(date -u +"%Y%m%d%H%M%S")
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV

          dotnet publish PixSmith.Web.JamTools/PixSmith.Web.JamTools.csproj \
            -c Release \
            -o publish \
            --nologo \
            -p:GHPages=true

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: publish/wwwroot
          force_orphan: true
        
      - name: Checkout specific branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      # ── 4. Inject build version into service worker ──────────────────────────
      - name: Inject build version into service-worker.js
        run: |
          SW_PATH="service-worker.js"
          sed -i "s/__BUILD_VERSION__/${{ env.BUILD_VERSION }}/g" "$SW_PATH"
          echo "Service worker cache version: ${{ env.BUILD_VERSION }}"

      - name: Commit and push
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          force_with_lease: true
      
